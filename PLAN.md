# ğŸ“¦ Plan: Embedding Ankurah in React Native via UniFFI

This plan enables running an embedded Ankurah node inside a **React Native app**, with:
- Native performance (Rust + Sled storage)
- Auto-generated TypeScript bindings (via UniFFI + uniffi-bindgen-react-native)
- API parity with the existing WASM bindings where possible
- iOS + Android support

---

## Status Overview

| Phase | Status | Description |
|-------|--------|-------------|
| Phase 1 | âœ… Complete | Proof of Concept (UniFFI + RN toolchain) |
| Phase 2 | âœ… Complete | Basic Ankurah Integration |
| Phase 3 | âœ… Complete | Model Derive Macros |
| Phase 4 | ğŸš§ In Progress | Reactive UI & Full App Port |

---

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     React Native App                        â”‚
â”‚                    (TypeScript/JSX)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              uniffi-bindgen-react-native                    â”‚
â”‚         (JSI Turbo Module - auto-generated)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Swift (iOS) / Kotlin (Android) - auto-generated         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Rust FFI Layer                           â”‚
â”‚              (ankurah-rn-bindings crate)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      Ankurah Core                           â”‚
â”‚        (Node, Context, Models, LiveQueries, etc.)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Sled Storage       â”‚      WebSocket Client                â”‚
â”‚   (local DB)         â”‚   (ankurah-websocket-client)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

The Swift/Kotlin layers are auto-generated by the toolchain - you don't write or maintain them directly.

### Key Versions

- **uniffi-rs**: 0.29.x (matches uniffi-bindgen-react-native)
- **uniffi-bindgen-react-native**: 0.29.3-1 ([changelog](https://github.com/jhugman/uniffi-bindgen-react-native/blob/main/CHANGELOG.md))
- **React Native**: Latest stable (bare RN, not Expo initially)

---

## Phase 1: Proof of Concept âœ… Complete

Verified the UniFFI + React Native toolchain works with async functions and callbacks.

- [x] Create `ankurah-react-native-template` repo
- [x] Set up bare React Native project
- [x] Create minimal UniFFI Rust crate with:
  - [x] Async function returning a value (`greet_async`)
  - [x] Callback-based subscription pattern (`Counter` + `CounterCallback`)
- [x] Wire together and verify on iOS simulator

---

## Phase 2: Ankurah Integration âœ… Complete

Added Ankurah with local development patching (via `akdev` script).

- [x] Add `ankurah-rn-bindings` crate
- [x] Integrate:
  - [x] `ankurah` with `uniffi` feature
  - [x] `ankurah-storage-sled` for local storage
  - [x] `ankurah-websocket-client` for server connectivity
- [x] Export core APIs: `Context`, node initialization
- [x] Set up `tracing` subscriber to forward Rust logs to RN console
- [x] Add panic hook for better error diagnostics

---

## Phase 3: Model Derive Macros âœ… Complete

Added `#[cfg(feature = "uniffi")]` code generation to ankurah-derive.

- [x] Generate monomorphized wrappers:
  - [x] `MessageView`, `MessageMutable` as UniFFI Objects
  - [x] `MessageResultSet`, `MessageLiveQuery`, `MessageChangeSet`
  - [x] `MessageRef` wrapper
  - [x] `MessageInput` Record for creation
- [x] `MessageOps` singleton: `get()`, `fetch()`, `query()`, `create()`, `create_one()`
- [x] Active type wrappers: `LWWString`, `YrsStringString`, etc.
- [x] `Json` custom type (converts to/from String at FFI boundary)
- [x] Maintain API parity with WASM bindings where possible

See `specs/uniffi-derive-integration.md` for full implementation details.

---

## Phase 4: Reactive UI & Full App Port ğŸš§ In Progress

Port the complete chat application from `ankurah-react-sled-template`.

### 4.1 React Native Signal Hooks âœ… Complete

Implemented RN equivalents of the WASM signal utilities:

| WASM (ankurah-react-sled-template) | React Native Equivalent |
|-----------------------------------|------------------------|
| `signalObserver(Component)` | Not needed (use `useObserve` directly) |
| `useObserve()` | `useObserve()` via UniFFI `ReactObserver` |
| `ReactObserver` (WASM) | `ReactObserver` (UniFFI) in `ankurah-signals` |

```typescript
// React Native usage
function RoomList() {
  const observer = useObserve();
  
  let rooms: RoomViewInterface[] = [];
  try {
    observer.beginTracking();
    rooms = liveQuery.items();
  } finally {
    observer.finish();
  }
  
  return <FlatList data={rooms} ... />;
}
```

### 4.2 Server (Verbatim Copy) âœ…

Server from `ankurah-react-sled-template` works unchanged - the React Native app connects to the same server.

### 4.3 Model (Verbatim Copy) âœ…

Models are identical:
- `User` - `display_name: String`
- `Room` - `name: String`
- `Message` - `user: Ref<User>`, `room: Ref<Room>`, `text: String`, `timestamp: i64`, `deleted: bool`

### 4.4 Port Components ğŸš§ Pending

Systematically port each component from `ankurah-react-sled-template/react-app/src/`:

| Component | Status | RN Considerations |
|-----------|--------|-------------------|
| Header | â¬œ | `View`, `Text`, `TouchableOpacity` |
| RoomList | â¬œ | `FlatList` instead of mapped divs |
| MessageRow | â¬œ | Core message display |
| MessageInput | â¬œ | `TextInput`, `KeyboardAvoidingView` |
| Chat | â¬œ | `FlatList` with inverted scroll |
| EditableTextField | â¬œ | Inline editing |
| MessageContextMenu | â¬œ | `Modal` or ActionSheet |
| ChatDebugHeader | â¬œ | Debug info display |
| DebugOverlay | â¬œ | Debug mode overlay |
| QRCodeModal | â¬œ | RN QR code library |

### 4.5 Platform-Specific Adaptations

| Web Feature | React Native Equivalent |
|-------------|------------------------|
| `localStorage` | `@react-native-async-storage/async-storage` |
| CSS files | `StyleSheet.create()` |
| `<div>`, `<span>` | `<View>`, `<Text>` |
| `<input>` | `<TextInput>` |
| `onClick` | `onPress` |
| `window.location` | Pass server URL as config |
| CSS hover states | Pressable states |
| Web notifications | RN push notifications |

### 4.6 Testing Checklist

- [x] Server starts and creates "General" room
- [x] RN app connects to server via WebSocket
- [ ] User is created/persisted on first launch
- [x] Room list displays and updates reactively
- [x] Rooms created in other clients appear in real-time
- [ ] Messages send and appear in real-time
- [ ] Messages sync between multiple clients
- [ ] User display name editing works
- [ ] Message deletion works
- [ ] Debug overlay functions correctly

---

## Project Structure

```
ankurah-react-native-template/
â”œâ”€â”€ akdev                      # Local ankurah dev toggle script
â”œâ”€â”€ Cargo.toml                 # Workspace root
â”œâ”€â”€ model/                     # Shared model definitions
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â””â”€â”€ src/lib.rs             # User, Room, Message models
â”œâ”€â”€ rn-bindings/               # UniFFI bindings crate
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ build.rs
â”‚   â””â”€â”€ src/lib.rs
â”œâ”€â”€ server/                    # Local dev server (optional)
â”‚   â”œâ”€â”€ Cargo.toml
â”‚   â””â”€â”€ src/main.rs
â”œâ”€â”€ rebuild-ios.sh             # Build script for iOS
â””â”€â”€ react-app/                 # React Native application
    â”œâ”€â”€ package.json
    â”œâ”€â”€ App.tsx
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ index.tsx          # Generated bindings re-export
    â”‚   â”œâ”€â”€ hooks/
    â”‚   â”‚   â”œâ”€â”€ index.ts
    â”‚   â”‚   â””â”€â”€ useObserve.ts  # Signal observer hook
    â”‚   â””â”€â”€ generated/         # Auto-generated by ubrn (not committed)
    â”œâ”€â”€ ios/
    â””â”€â”€ android/
```

---

## Prerequisites

- Rust toolchain: `rustup`, `cargo`
- `cargo-ndk` for Android builds
- Node.js + bun (or npm/yarn)
- Xcode + CocoaPods (iOS)
- Android SDK + NDK (Android)
- React Native CLI

---

## References

- [Ankurah](https://github.com/ankurah/ankurah)
- [UniFFI](https://mozilla.github.io/uniffi-rs/)
- [uniffi-bindgen-react-native](https://github.com/jhugman/uniffi-bindgen-react-native)
- [uniffi-bindgen-react-native Changelog](https://github.com/jhugman/uniffi-bindgen-react-native/blob/main/CHANGELOG.md)
- [React Native CLI](https://reactnative.dev/docs/environment-setup)
