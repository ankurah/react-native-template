name: Prepare Template

on:
    push:
        branches:
            - dev

jobs:
    test:
        name: Build and Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Cache Rust dependencies
              uses: Swatinem/rust-cache@v2

            - name: Check Rust workspace
              run: cargo check --workspace

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: Install npm dependencies
              working-directory: react-app
              run: npm install
            # Note: TypeScript check skipped because generated bindings (src/generated/*)
            # require building Rust for iOS/Android via `npx ubrn build`

    promote:
        name: Promote to main
        runs-on: ubuntu-latest
        needs: [test]
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: dev
                  fetch-depth: 0

            - name: Prepare transformed tree
              run: |
                  set -euo pipefail
                  # Remove dev-only files
                  rm -f akdev
                  find react-app -name '*.tsx' -print0 \
                    | while IFS= read -r -d '' file; do \
                        perl -0pi -e 's/\{\{ (.*?:.*?) \}\}/{% raw %}{{$1}}{% endraw %}/gs' "$file"; \
                      done
                  # Template the iOS app name (PascalCase)
                  # Rename folders and files
                  mv react-app/ios/AnkurahApp 'react-app/ios/{{project-name | pascal_case}}'
                  mv react-app/ios/AnkurahApp.xcodeproj 'react-app/ios/{{project-name | pascal_case}}.xcodeproj'
                  mv react-app/ios/AnkurahApp.xcworkspace 'react-app/ios/{{project-name | pascal_case}}.xcworkspace'
                  mv react-app/ios/AnkurahApp.h 'react-app/ios/{{project-name | pascal_case}}.h'
                  mv react-app/ios/AnkurahApp.mm 'react-app/ios/{{project-name | pascal_case}}.mm'
                  # Rename scheme file inside xcodeproj (path changed after folder rename)
                  mv 'react-app/ios/{{project-name | pascal_case}}.xcodeproj/xcshareddata/xcschemes/AnkurahApp.xcscheme' \
                     'react-app/ios/{{project-name | pascal_case}}.xcodeproj/xcshareddata/xcschemes/{{project-name | pascal_case}}.xcscheme'
                  # Replace AnkurahApp in file contents
                  find . -type f -not -path './.git/*' -print0 \
                    | xargs -0 perl -pi -e 's/AnkurahApp/{{project-name | pascal_case}}/g'
                  # Template project name (kebab-case) and crate name (snake_case)
                  find . -type f -not -path './.git/*' -print0 \
                    | xargs -0 perl -pi -e 's/ankurah-rn/{{project-name}}/g'
                  find . -type f -not -path './.git/*' -print0 \
                    | xargs -0 perl -pi -e 's/ankurah_rn/{{crate_name}}/g'
                  git log -1 --pretty=%B dev > /tmp/dev-commit-msg
                  rm -rf .github
                  mkdir -p /tmp/prepared
                  rsync -a --delete --exclude '.git/' ./ /tmp/prepared/
                  git reset --hard HEAD
                  git clean -fd

            - name: Update main branch
              run: |
                  set -euo pipefail
                  git fetch origin main || true
                  if git rev-parse --verify origin/main >/dev/null 2>&1; then
                    git checkout -B main origin/main
                  else
                    git checkout -B main
                  fi
                  rsync -a --delete --exclude '.git/' /tmp/prepared/ ./
                  rm -rf .github
                  git config user.name "ankurah-bot"
                  git config user.email "infra@ankurah.dev"
                  git add -A
                  if git diff --cached --quiet; then
                    echo "No changes to commit"
                    exit 0
                  fi
                  git commit -F /tmp/dev-commit-msg
                  git push origin HEAD:main
